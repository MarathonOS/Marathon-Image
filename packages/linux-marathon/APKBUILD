# Contributor: Patrick Quinn <patrick@jquinn.com>
# Maintainer: Patrick Quinn <patrick@jquinn.com>

# This package can be built for different devices by setting _device
# Example: _device=enchilada abuild -r
_device="${device:-enchilada}"

pkgname=linux-marathon
pkgver=6.17.3
pkgrel=0
pkgdesc="Marathon OS optimized Linux kernel for ARM64 mobile devices ($_device)"
url="https://kernel.org"
arch="aarch64"
license="GPL-2.0-only"
depends="initramfs-generator"
provides="linux"
replaces="linux-postmarketos-qcom-sdm845 postmarketos-qcom-sdm845"
provider_priority=100
makedepends="
	bison
	findutils
	flex
	gmp-dev
	mpc1-dev
	mpfr-dev
	openssl-dev
	perl
	postmarketos-installkernel
	rsync
	xz
"
options="!strip !check !tracedeps"
source="
	https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-$pkgver.tar.xz
	config-marathon-complete.aarch64
"
builddir="$srcdir/linux-$pkgver"

# Add device-specific config fragment if it exists
if [ -f "../../devices/$_device/kernel-config.fragment" ]; then
	source="$source
		../../devices/$_device/kernel-config.fragment"
fi

prepare() {
	default_prepare
	
	# Use complete Marathon config (no merge needed)
	msg "Using complete Marathon kernel config..."
	cp "$srcdir/config-marathon-complete.aarch64" .config
	
	# Verify MSM drivers are in config
	msg "Verifying MSM drivers in config:"
	grep -E "CONFIG_DRM_MSM|CONFIG_QCOM_LLCC|CONFIG_QCOM_OCMEM" .config || msg "WARNING: MSM drivers not found in config!"
	
	# Let kconfig resolve any missing options
	make ARCH=arm64 olddefconfig
	msg "Kernel config preparation completed"
}

build() {
	unset LDFLAGS
	make ARCH=arm64 \
		KBUILD_BUILD_VERSION="$((pkgrel + 1))-Marathon-$_device"
}

package() {
	mkdir -p "$pkgdir"/boot
	make -j1 ARCH=arm64 \
		INSTALL_MOD_PATH="$pkgdir" \
		INSTALL_MOD_STRIP=1 \
		INSTALL_DTBS_PATH="$pkgdir/boot/dtbs-marathon" \
		modules_install dtbs_install
	
	install -Dm644 arch/arm64/boot/Image \
		"$pkgdir/boot/vmlinuz-marathon"
	
	install -D include/config/kernel.release \
		"$pkgdir/usr/share/kernel/marathon/kernel.release"
	
	# Create symlink for compatibility with postmarketos-qcom-sdm845
	ln -s vmlinuz-marathon "$pkgdir/boot/vmlinuz-postmarketos-qcom-sdm845"
}

sha512sums="
b2c77d3d0bee221a970dd020f71d10843275994538a98584129887db20854bcceb5da3f5fa057ebc42d8d8714cb9bcb36239716ea59a70c56c8f9d2a16421fa6  linux-6.17.3.tar.xz
0fc9edef2ef69bbfa452a0ad935c42d6273aba32fa5249a22cd8b50da84d214f2664f0255002e76a858444b750b5fb4968e09f5d0d3566eb45ddea790328df15  config-marathon-base.aarch64
"
